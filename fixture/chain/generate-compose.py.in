#!/usr/bin/env python3

import argparse
import re
import yaml
import os

def get_networks(num_regions, num_chains):
    networks = {}

    networks['internet'] = None

    for ri in range(num_regions):
        for ci in range(num_chains):
            name = 'region-{}.chain-{}'.format(ri, ci)
            networks[name] = None

    return networks

def get_services(num_chains, num_regions, num_sentries):
    services = {}

    workers = [
        'validator',
        'sentry',
        'seed',
        'full',
        'seat',
    ]
    types = workers + ['administrator']
    for ci in range(num_chains):
        for ri in range(num_regions):
            for type in types:
                service = {}
                service['image'] = '@APP_NAME@:@FIXTURE_DAEMON_VERSION@'

                # networks
                networks = {}
                network_private = 'region-{}.chain-{}'.format(ri, ci)
                networks[network_private] = {
                    'aliases': [
                        '{}'.format(type),
                    ],
                }

                if type in ['sentry', 'seed', 'full']:
                    network_public = 'internet'
                    networks[network_public] = None
                service['networks'] = networks

                # deploy
                if type == 'sentry':
                    service['deploy'] = {
                        'replicas': num_sentries,
                    }

                service_name = '{}.region-{}.chain-{}'.format(type, ri, ci)
                services[service_name] = service

    return services

def main():
    parser = argparse.ArgumentParser()
    parser.add_argument('--output', '-o', type=str,
                        help="output file path (default: stdout)")
    # parser.add_argument('--name', '-n', type=str, required=True,
    #                     help="the name of the chains (docker-compose name)")
    parser.add_argument('--chains', '-c', type=int, default=1,
                        help="the number of chains in the fixture")
    parser.add_argument('--regions', '-r', type=int, default=1,
                        help="the number of regions in the fixture")
    parser.add_argument('--sentries', '-s', type=int, default=1,
                        help="the number of sentries in each region")
    args = parser.parse_args()

    document = {
        # 'name': args.name,
        'services': get_services(args.chains, args.regions, args.sentries),
        'networks': get_networks(args.regions, args.chains),
    }

    yaml.SafeDumper.add_representer(
        type(None),
        lambda dumper, value: dumper.represent_scalar(u'tag:yaml.org,2002:null', ''))

    if args.output is not None:
        with open(args.output, 'w') as f:
            yaml.safe_dump(document, f)
    else:
        print(yaml.safe_dump(document, default_flow_style=False))

if __name__ == '__main__':
    main()
