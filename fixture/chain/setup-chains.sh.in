#!/bin/sh

set -xe

. @CMAKE_SOURCE_DIR@/fixture/util/common.sh
. @CMAKE_SOURCE_DIR@/fixture/util/service.sh

# TODO: add the fixture
cosmovisor=@COSMOVISOR_BINARY_DIR@/cosmovisor
prepare_cosmovisor() {
	if [ ! -f $cosmovisor ]
	then
		cmake --build @CMAKE_BINARY_DIR@ --target build_cosmovisor
	fi
}

initialize() {
	local region_index=$1
	local chain_index=$2

	local admin=$(service_name administrator $region_index $chain_index)

	service_exec $admin "cd && ansible-playbook -i inventory initialize.yml \\
-e daemon_name=@DAEMON_NAME@ \\
-e daemon_home=@DAEMON_HOME@ \\
-e region_index=$region_index \\
-e chain_index=$chain_index \\
-e config_timeout_propose=@FIXTURE_CONFIG_TIMEOUT_PROPOSE@ \\
-e config_timeout_prevote=@FIXTURE_CONFIG_TIMEOUT_PREVOTE@ \\
-e config_timeout_precommit=@FIXTURE_CONFIG_TIMEOUT_PRECOMMIT@ \\
-e config_timeout_commit=@FIXTURE_CONFIG_TIMEOUT_COMMIT@ \\
-e client_keyring_backend=@FIXTURE_CLIENT_KEYRING_BACKEND@"
}

generate_gentxs() {
	local region_index=$1
	local chain_index=$2

	local admin=$(service_name administrator $region_index $chain_index)

	service_exec $admin "cd && ansible-playbook -i inventory genesis.yml \\
-e phase=generate \\
-e daemon_name=@DAEMON_NAME@ \\
-e daemon_home=@DAEMON_HOME@ \\
-e region_index=$region_index \\
-e chain_index=$chain_index \\
-e state_bond_denom=@FIXTURE_STATE_BOND_DENOM@ \\
-e state_balance=@FIXTURE_STATE_BALANCE@ \\
-e state_delegation=@FIXTURE_STATE_DELEGATION@"
	service_fetch $admin /root/artifact/seat/address.txt $_genesis_dir/address-$region_index.txt
	service_fetch $admin /root/artifact/seat/gentx.json $_genesis_dir/gentx-$region_index.json
}

distribute_genesis() {
	local region_index=$1
	local chain_index=$2

	local admin=$(service_name administrator $region_index $chain_index)

	service_exec $admin "mkdir -p /root/artifact/genesis"
	service_push $admin $_genesis_dir/genesis.json /root/artifact/genesis/
	service_exec $admin "cd && ansible-playbook -i inventory genesis.yml \\
-e phase=distribute \\
-e daemon_home=@DAEMON_HOME@"
}

gather_configs() {
	local region_index=$1
	local chain_index=$2

	local admin=$(service_name administrator $region_index $chain_index)

	service_exec $admin "cd && ansible-playbook -i inventory config.yml \\
-e phase=gather"
	mkdir $_dynamic_dir/$region_index
	service_fetch $admin /root/artifact/seed/public-ip.txt $_dynamic_dir/$region_index/
	service_fetch $admin /root/artifact/seed/node-id.txt $_dynamic_dir/$region_index/
}

apply_configs() {
	local region_index=$1
	local chain_index=$2

	local admin=$(service_name administrator $region_index $chain_index)

	service_exec $admin "mkdir -p /root/artifact/seeds"
	service_push $admin $_dynamic_dir/. /root/artifact/seeds/
	service_exec $admin "cd && ansible-playbook -i inventory config.yml \\
-e phase=apply \\
-e daemon_home=@DAEMON_HOME@ \\
-e region_index=$region_index"
}

assert_variables NUM_CHAINS \
				 NUM_REGIONS \
				 NUM_SENTRIES

prepare_cosmovisor

for _ci in $(seq 0 $(expr $NUM_CHAINS - 1))
do
	# prepare binaries on admin
	for _ri in $(seq 0 $(expr $NUM_REGIONS - 1))
	do
		_admin=$(service_name administrator $_ri $_ci)

		_version=@FIXTURE_DAEMON_VERSION@
		service_exec $_admin "mkdir -p ~/daemon/$_version"
		service_push $_admin $cosmovisor "/root/"
		# service_push $_admin @DAEMON_BINARY_DIR@/$_version/bundle.tar.gz ~/daemon/$_version/
		service_push $_admin @DAEMON_BINARY_DIR@/$_version/bundle.tar.gz "/root/"
	done

	_genesis_dir=genesis/$_ci
	rm -rf $_genesis_dir
	mkdir -p $_genesis_dir

	_dynamic_dir=seeds/$_ci
	rm -rf $_dynamic_dir
	mkdir -p $_dynamic_dir

	# initialize
	_pending_pids=
	for _ri in $(seq 0 $(expr $NUM_REGIONS - 1))
	do
		initialize $_ri $_ci &
		_pending_pids="$_pending_pids $!"
	done
	wait_pids $_pending_pids

	# generate gentxs
	_pending_pids=
	for _ri in $(seq 0 $(expr $NUM_REGIONS - 1))
	do
		generate_gentxs $_ri $_ci &
		_pending_pids="$_pending_pids $!"
	done
	wait_pids $_pending_pids

	# collect gentxs
	for _ri in 0
	do
		_admin=$(service_name administrator $_ri $_ci)

		service_push $_admin $_genesis_dir/. /root/artifact/genesis/
		service_exec $_admin "cd && ansible-playbook -i inventory genesis.yml \\
-e phase=collect \\
-e daemon_name=@DAEMON_NAME@ \\
-e daemon_home=@DAEMON_HOME@ \\
-e state_bond_denom=@FIXTURE_STATE_BOND_DENOM@ \\
-e state_balance=@FIXTURE_STATE_BALANCE@ \\
-e state_delegation=@FIXTURE_STATE_DELEGATION@ \\
-e state_unbonding_time=@FIXTURE_STATE_UNBONDING_TIME@ \\
-e state_min_deposit=@FIXTURE_STATE_MIN_DEPOSIT@ \\
-e state_voting_period=@FIXTURE_STATE_VOTING_PERIOD@"
		service_fetch $_admin /root/artifact/genesis/genesis.json $_genesis_dir/
	done

	# distribute genesis
	_pending_pids=
	for _ri in $(seq 0 $(expr $NUM_REGIONS - 1))
	do
		distribute_genesis $_ri $_ci &
		_pending_pids="$_pending_pids $!"
	done
	wait_pids $_pending_pids

	# gather dynamic information
	_pending_pids=
	for _ri in $(seq 0 $(expr $NUM_REGIONS - 1))
	do
		gather_configs $_ri $_ci &
		_pending_pids="$_pending_pids $!"
	done
	wait_pids $_pending_pids

	# update dynamic information
	_pending_pids=
	for _ri in $(seq 0 $(expr $NUM_REGIONS - 1))
	do
		apply_configs $_ri $_ci &
		_pending_pids="$_pending_pids $!"
	done
	wait_pids $_pending_pids

	# run cosmovisor
	for _ri in $(seq 0 $(expr $NUM_REGIONS - 1))
	do
		_admin=$(service_name administrator $_ri $_ci)

		service_exec $_admin "cd && ansible -i inventory all -m ansible.builtin.service -a 'name=cosmovisor enabled=true state=started'"
	done
done

unhealthy_services=$(get_services | grep -Ev '^administrator\.')
while [ -n "$unhealthy_services" ]
do
	_services="$unhealthy_services"
	unhealthy_services=
	for _service in $_services
	do
		if [ $(service_health $_service) != healthy ]
		then
			unhealthy_services="$unhealthy_services $_service"
			if [ $(service_status $_service) != running ]
			then
				echo "Error on: " $_service >&2
				false
			fi
			sleep 1
		fi
	done
done
