#!/bin/sh

set -xe

. @CMAKE_SOURCE_DIR@/fixture/util/common.sh
. @CMAKE_SOURCE_DIR@/fixture/util/service.sh

# stop the sentries
sentries="$(get_services sentry)"
for _sentry in $sentries
do
	service_exec $_sentry "touch /etc/sv/cosmovisor/down && sv down cosmovisor"
done

# stop the sentries and wait for the chain pausing
num_validators=$(get_services validator | wc -l)
while true
do
	_num_unhealthy=0
	for _validator in $(get_services validator)
	do
		if [ $(service_health $_validator) = unhealthy ]
		then
			_num_unhealthy=$(expr $_num_unhealthy + 1)
		else
			break
		fi
	done

	if [ $_num_unhealthy -eq $num_validators ]
	then
		break
	fi

	sleep 1
done

# start the sentries
for _sentry in $sentries
do
	service_exec $_sentry "rm /etc/sv/cosmovisor/down && sv up cosmovisor"
done

# wait for the recovery
while true
do
	_num_healthy=0
	for _validator in $(get_services validator)
	do
		if [ $(service_health $_validator) = healthy ]
		then
			_num_healthy=$(expr $_num_healthy + 1)
		else
			break
		fi
	done

	if [ $_num_healthy -eq $num_validators ]
	then
		break
	fi

	sleep 1
done
