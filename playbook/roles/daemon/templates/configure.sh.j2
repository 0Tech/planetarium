#!/bin/sh

set -e

# ansible.builtin.template
DAEMON_HOME={{ daemon_home }}
TYPE={{ type }}
CHAIN_ID={{ chain_id }}
TIMEOUT_PROPOSE={{ timeout_propose }}
TIMEOUT_PREVOTE={{ timeout_prevote }}
TIMEOUT_PRECOMMIT={{ timeout_precommit }}
TIMEOUT_COMMIT={{ timeout_commit }}
KEYRING_BACKEND={{ keyring_backend }}

replace_toml() {
	local file=$1
	local key=$2
	local value=$3

	sed -Ei $file -e 's#^'$key'[[:blank:]]*=.*$#'$key' = '$value'#'
}

## update config.toml ##
if [ $TYPE = full ]
then
	sed -Ei $DAEMON_HOME/config/config.toml -e 's#127\.0\.0\.1:26657#0.0.0.0:26657#'
fi

replace_toml $DAEMON_HOME/config/config.toml addr_book_strict false

if [ $TYPE = validator ]
then
	replace_toml $DAEMON_HOME/config/config.toml pex false
fi

replace_toml $DAEMON_HOME/config/config.toml timeout_propose '"'$TIMEOUT_PROPOSE'"'
replace_toml $DAEMON_HOME/config/config.toml timeout_prevote '"'$TIMEOUT_PREVOTE'"'
replace_toml $DAEMON_HOME/config/config.toml timeout_precommit '"'$TIMEOUT_PRECOMMIT'"'
replace_toml $DAEMON_HOME/config/config.toml timeout_commit '"'$TIMEOUT_COMMIT'"'

if [ $TYPE != full ]
then
	replace_toml $DAEMON_HOME/config/config.toml indexer '"null"'
fi

## update client.toml ##
replace_toml $DAEMON_HOME/config/client.toml chain-id '"'$CHAIN_ID'"'
replace_toml $DAEMON_HOME/config/client.toml keyring-backend '"'$KEYRING_BACKEND'"'
replace_toml $DAEMON_HOME/config/client.toml output '"json"'

## update app.toml ##
if [ $TYPE != full ]
then
	replace_toml $DAEMON_HOME/config/app.toml pruning '"everything"'
	replace_toml $DAEMON_HOME/config/app.toml min-retain-blocks 1
fi
